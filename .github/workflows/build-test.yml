name: Check

on:
  pull_request: # Check Pull Requests

  push:
    branches:
      - main # Check branch after merge

  schedule:
    - cron: "0 4 * * *" # Nightly build (@daily)

concurrency:
  # Only run once for latest commit per ref and cancel other (previous) runs.
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # for checkout

jobs:
  extra-vars:
    name: Extra variables
    runs-on: ubuntu-20.04
    outputs:
      akka_version_opts: ${{ steps.akka-snapshots.outputs.akka_opts }}
      akka_http_version_opts: ${{ steps.akka-snapshots.outputs.akka_http_opts }}
    steps:
      - id: akka-snapshots
        run: |
          if [ "$GITHUB_EVENT_NAME" = "schedule" ]; then
            AKKA_VERSION=$(curl -s https://oss.sonatype.org/content/repositories/snapshots/com/typesafe/akka/akka-actor_2.13/ | grep -oEi '2\.6\.[0-9]+\+[RCM0-9]+-[0-9a-f]{8}-SNAPSHOT' | sort -V | tail -n 1)
            AKKA_HTTP_VERSION=$(curl -s https://oss.sonatype.org/content/repositories/snapshots/com/typesafe/akka/akka-http-core_2.13/ | grep -oEi '10\.1\.[0-9]+\+[RCM0-9]+-[0-9a-f]{8}-SNAPSHOT' | sort -V | tail -n 1)
            echo "::set-output name=akka_opts::-Dakka.version=$AKKA_VERSION"
            echo "::set-output name=akka_http_opts::-Dakka.http.version=$AKKA_HTTP_VERSION"
          else
            echo "::set-output name=akka_opts::"
            echo "::set-output name=akka_http_opts::"
          fi

  tests:
    name: Tests
    needs:
      - "extra-vars"
    uses: playframework/.github/.github/workflows/cmd.yml@nice-json
    with:
      java: 17, 11
      scala: 2.13.x
      add-dimensions: >-
        {
          "sbt_test_task": [ "test", "Play-Integration-Test/It/test", "Play-Microbenchmark/jmh:run -i 1 -wi 0 -f 1 -t 1 -foe=true" ]
        }
      exclude: >-
        [
          { "java": "${{ github.event_name == 'schedule' || '17' }}" },
          { "sbt_test_task": "${{ github.event_name == 'schedule' || 'Play-Microbenchmark/jmh:run -i 1 -wi 0 -f 1 -t 1 -foe=true' }}" }
        ]
      cmd: >-
        if [ "$MATRIX_JAVA" = 17 ]; then
          export JAVA_TOOL_OPTIONS="$JAVA_TOOL_OPTIONS --add-exports=java.base/sun.security.x509=ALL-UNNAMED --add-opens=java.base/sun.security.ssl=ALL-UNNAMED";
        fi;
        sbt "${{needs.extra-vars.outputs.akka_version_opts}}" "${{needs.extra-vars.outputs.akka_http_version_opts}}" ++$MATRIX_SCALA "$MATRIX_SBT_TEST_TASK"
